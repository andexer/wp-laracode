<?php

namespace {{namespace}}\WordPress\Providers;

use Illuminate\Database\Capsule\Manager as Capsule;
use Illuminate\Support\ServiceProvider;

class DatabaseServiceProvider extends ServiceProvider
{
    /**
     * The default connection name for this plugin.
     */
    protected const CONNECTION_NAME = 'default';

    public function register()
    {
        $capsule = new Capsule;

        $config = [
            'driver'    => 'mysql',
            'host'      => defined('DB_HOST') ? DB_HOST : 'localhost',
            'database'  => defined('DB_NAME') ? DB_NAME : '',
            'username'  => defined('DB_USER') ? DB_USER : '',
            'password'  => defined('DB_PASSWORD') ? DB_PASSWORD : '',
            'charset'   => defined('DB_CHARSET') ? DB_CHARSET : 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
            'prefix'    => isset($GLOBALS['wpdb']) ? $GLOBALS['wpdb']->prefix : 'wp_',
        ];

        if (function_exists('apply_filters')) {
            $config = apply_filters('{{slug}}_database_config', $config);
        }

        // Add the connection as 'default' so Eloquent finds it automatically
        $capsule->addConnection($config, self::CONNECTION_NAME);

        // Ensure this connection is the default for this capsule instance
        $capsule->getDatabaseManager()->setDefaultConnection(self::CONNECTION_NAME);

        // IMPORTANT: bootEloquent() sets the global resolver for Model classes
        // Each plugin in wp-laracode boots its own, which is fine as they share the same WP DB
        $capsule->bootEloquent();

        // Bind the capsule to the container
        $this->app->singleton('db', fn() => $capsule);
        $this->app->singleton('db.connection', fn() => $capsule->getConnection(self::CONNECTION_NAME));

        // Alias for convenience
        $this->app->alias('db', Capsule::class);
    }

    public function boot()
    {
        // Set the default connection for models
        $connection = $this->app->make('db.connection');

        // If you need to run raw queries on the WordPress database
        // Use: app('db.connection')->table('posts')->get();
    }

    /**
     * Get the connection name.
     *
     * @return string
     */
    public static function getConnectionName(): string
    {
        return self::CONNECTION_NAME;
    }
}
